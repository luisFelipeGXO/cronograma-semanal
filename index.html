<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma Semanal | Visualizador</title>
    <!-- Fonte Inter para um visual moderno e limpo -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /*
         * 1. RESET BÁSICO E VARIÁVEIS CSS
         */
        :root {
            /* Cores Light Mode */
            --color-bg-primary: #f9f9f9;
            --color-bg-secondary: #ffffff;
            --color-text-primary: #1f2937;
            --color-text-secondary: #6b7280;
            --color-accent: #3b82f6; /* Azul Primário */
            --color-accent-hover: #2563eb;
            --color-border: #e5e7eb;
            --color-shadow: rgba(0, 0, 0, 0.05);

            /* Cores de Categoria (AJUSTADAS PARA REDUZIR O VERMELHO) */
            --color-type-trabalho: #facc15; /* Amarelo */
            --color-type-foco: #10b981; /* Esmeralda */
            --color-type-pessoal: #06b6d4; /* NOVO: Ciano Calmo/Turquesa */
            --color-type-aprendizado: #8b5cf6; /* Violeta */
            --color-type-social: #f472b6; /* Rosa */
            
            /* Destaque e Conflito (MANTÉM O VERMELHO FORTE PARA ALERTA DE CONFLITO) */
            --color-current-time: #10b981;
            --color-conflict: #ef4444;
        }

        /* Dark Mode */
        body.dark-mode {
            --color-bg-primary: #111827;
            --color-bg-secondary: #1f2937;
            --color-text-primary: #f9fafb;
            --color-text-secondary: #9ca3af;
            --color-border: #374151;
            --color-shadow: rgba(255, 255, 255, 0.05);
            --color-accent: #60a5fa;
            --color-accent-hover: #3b82f6;
        }

        /* Reset básico */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /*
         * 2. LAYOUT GERAL E NAVEGAÇÃO
         */

        .container {
            max-width: 1400px;
            width: 95%;
            margin: 20px auto;
            padding: 20px;
            flex-grow: 1;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Tabs de Navegação */
        .tabs {
            display: flex;
            background-color: var(--color-bg-secondary);
            border-radius: 8px;
            padding: 4px;
            box-shadow: var(--color-shadow) 0px 10px 15px -3px, var(--color-shadow) 0px 4px 6px -2px;
            border: 1px solid var(--color-border);
        }

        .tab-button {
            background-color: transparent;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            color: var(--color-text-secondary);
            transition: color 0.2s, background-color 0.2s;
            border-radius: 6px;
            flex-grow: 1;
            text-align: center;
        }

        .tab-button.active {
            background-color: var(--color-accent);
            color: var(--color-bg-secondary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .tab-button:hover:not(.active) {
            color: var(--color-text-primary);
            background-color: var(--color-border);
        }
        
        /* Controles de Configuração */
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }

        /* Toggle Dark Mode */
        .dark-mode-toggle {
            cursor: pointer;
            width: 40px;
            height: 20px;
            background-color: var(--color-border);
            border-radius: 10px;
            position: relative;
            transition: background-color 0.3s;
            border: 1px solid var(--color-border);
            flex-shrink: 0;
        }
        
        .dark-mode-toggle::after {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            width: 16px;
            height: 16px;
            background-color: var(--color-bg-secondary);
            border-radius: 50%;
            transition: left 0.3s, background-color 0.3s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        body.dark-mode .dark-mode-toggle {
            background-color: var(--color-accent);
        }

        body.dark-mode .dark-mode-toggle::after {
            left: 21px;
        }


        /*
         * 3. VISÃO AGORA (NOW VIEW)
         */
        
        #now-view {
            padding: 30px 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .now-status {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 20px;
            color: var(--color-text-secondary);
        }

        .now-status .time {
            font-weight: 700;
            color: var(--color-accent);
        }

        .current-event-card {
            background-color: var(--color-bg-secondary);
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 30px var(--color-shadow);
            border-left: 5px solid var(--color-current-time);
            text-align: left;
            opacity: 0; /* Começa invisível para JS animar */
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        .event-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 10px;
            line-height: 1.2;
        }

        .event-time-range {
            font-size: 1.2rem;
            color: var(--color-text-secondary);
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .event-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--color-bg-primary);
            text-transform: uppercase;
        }

        /*
         * 4. VISÃO SEMANAL (WEEKLY VIEW) - CSS GRID
         */

        #weekly-view {
            overflow-x: auto;
            padding-bottom: 15px; /* Espaço para sombra e scrollbar */
        }

        .schedule-grid {
            display: grid;
            /* 1 coluna para horário + 7 colunas para os dias */
            grid-template-columns: 80px repeat(7, minmax(120px, 1fr));
            min-width: 900px; /* Garante que a grade não fique muito espremida em desktop */
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background-color: var(--color-bg-secondary);
            box-shadow: 0 4px 10px var(--color-shadow);
        }

        /* Células base */
        .grid-header, .time-label, .grid-cell {
            padding: 8px;
            border-bottom: 1px solid var(--color-border);
            border-right: 1px solid var(--color-border);
            text-align: center;
        }

        .time-label {
            text-align: right;
            padding-right: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            background-color: var(--color-bg-primary);
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            position: relative;
        }
        
        /* Marcador de Tempo Atual na Grade */
        .time-label.current-time::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -5px;
            width: 10px;
            height: 10px;
            background-color: var(--color-current-time);
            border-radius: 50%;
            transform: translateY(-50%);
            box-shadow: 0 0 5px var(--color-current-time);
        }

        /* Cabeçalhos */
        .grid-header {
            font-weight: 700;
            background-color: var(--color-accent);
            color: var(--color-bg-secondary);
            padding: 12px 8px;
            border-color: var(--color-accent-hover);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .grid-header:first-child {
             background-color: var(--color-bg-primary);
             color: var(--color-text-primary);
             border-color: var(--color-border);
        }
        
        .grid-cell {
            min-height: 50px;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 5px;
            position: relative;
        }

        .grid-cell:last-child, .time-label:last-child {
            border-bottom: none;
        }
        
        .grid-cell:nth-child(8n) { /* Última coluna do dia (Sábado) */
            border-right: none;
        }

        /* Estilo do Evento na Grade */
        .grid-event {
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--color-bg-secondary); /* Texto claro no evento colorido */
            opacity: 0.9;
            transition: opacity 0.2s;
            cursor: default;
        }
        
        .grid-event:hover {
            opacity: 1;
        }
        
        .grid-event strong {
            display: block;
            white-space: normal;
        }
        
        /* Destaque do Evento Atual */
        .grid-event.is-current {
            outline: 2px solid var(--color-current-time);
            outline-offset: -2px;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5); /* Sombra verde sutil */
            opacity: 1;
        }

        /* Destaque de Colisão */
        .grid-cell.has-conflict {
            background-color: rgba(239, 68, 68, 0.1);
        }
        
        .grid-event.is-conflict {
            background-color: var(--color-conflict) !important;
            border: 2px solid #fff; /* Borda para contraste */
            z-index: 2;
        }

        /* Estilos por Tipo (Type Colors) */
        .type-Trabalho { background-color: var(--color-type-trabalho); }
        .type-Foco { background-color: var(--color-type-foco); }
        .type-Pessoal { background-color: var(--color-type-pessoal); }
        .type-Aprendizado { background-color: var(--color-type-aprendizado); }
        .type-Social { background-color: var(--color-type-social); }
        
        /* Badge para Visão Agora - Ajuste a cor do texto para o Pessoal que é mais claro */
        .type-Trabalho.badge { background-color: var(--color-type-trabalho); color: #1f2937; }
        .type-Foco.badge { background-color: var(--color-type-foco); color: #1f2937; }
        .type-Pessoal.badge { background-color: var(--color-type-pessoal); color: var(--color-bg-primary); } /* Mantém o texto claro */
        .type-Aprendizado.badge { background-color: var(--color-type-aprendizado); }
        .type-Social.badge { background-color: var(--color-type-social); }
        
        /* 5. RESPONSIVIDADE (Mobile/Tablet) */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .tabs {
                width: 100%;
                margin-bottom: 20px;
            }
            
            header h1 {
                font-size: 1.3rem;
            }
            
            /* Visão Agora */
            .event-title {
                font-size: 1.5rem;
            }
            
            /* Visão Semanal (A grade permite scroll horizontal) */
            .schedule-grid {
                min-width: 700px;
            }
            
            .grid-template-columns {
                grid-template-columns: 60px repeat(7, 1fr);
            }
            
            .time-label {
                width: 60px; /* Ajusta a largura da coluna de horário */
                font-size: 0.75rem;
            }
            
            .grid-event {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1><span id="current-date-info"></span> Cronograma</h1>
            <div class="controls">
                <div class="control-group">
                    <label for="timezone-select" title="Simular fuso horário">Fuso:</label>
                    <select id="timezone-select" aria-label="Seleção de Fuso Horário" class="tab-button" onchange="window.app.handleTimezoneChange(this.value)">
                        <option value="-3" selected>UTC-3 (BRT)</option>
                        <option value="-5">UTC-5 (EST)</option>
                        <option value="0">UTC±0 (GMT)</option>
                        <option value="1">UTC+1 (CET)</option>
                        <option value="9">UTC+9 (JST)</option>
                    </select>
                </div>
                <div class="control-group">
                    <button class="dark-mode-toggle" id="dark-mode-toggle" aria-label="Alternar Modo Escuro"></button>
                </div>
            </div>
        </header>

        <nav class="tabs" role="tablist">
            <button class="tab-button active" data-tab="now-view" role="tab" aria-selected="true" aria-controls="now-view" onclick="window.app.activateTab('now-view')">Agora</button>
            <button class="tab-button" data-tab="weekly-view" role="tab" aria-selected="false" aria-controls="weekly-view" onclick="window.app.activateTab('weekly-view')">Visão Semanal</button>
        </nav>

        <main class="content">
            <!-- VISÃO AGORA (NOW VIEW) -->
            <section id="now-view" role="tabpanel" aria-labelledby="tab-now-view">
                <!-- Conteúdo gerado por JS -->
            </section>

            <!-- VISÃO SEMANAL (WEEKLY VIEW) -->
            <section id="weekly-view" role="tabpanel" aria-labelledby="tab-weekly-view" style="display:none;">
                <!-- O grid será inserido aqui pelo JS -->
            </section>
        </main>
    </div>

    <script>
        // Bloco de script ES6+ para toda a lógica da aplicação
        
        // =======================================================================
        // 1. DADOS E CONFIGURAÇÕES
        // =======================================================================
        
        // Definição dos dados do cronograma (o cliente pode substituir este JSON)
        // OBS: Os horários são em HH:MM (24h) e serão interpretados no fuso
        // horário local + o offset de fuso horário configurado.
        const SCHEDULE_DATA = {
            // Os dias são em português e seguem a ordem de new Date().getDay() (0=Dom, 1=Seg...)
            // Mas o objeto usa as chaves 'segunda' a 'domingo' para facilidade de leitura.
            
            // CRONOGRAMA ATUALIZADO
            segunda: [
                { title: "Acordar", start: "07:00", end: "07:10", type: "Pessoal" },
                { title: "Café da Manhã", start: "07:20", end: "07:40", type: "Trabalho" },
                { title: "Estudar", start: "07:40", end: "09:00", type: "Pessoal" },
                { title: "Academia", start: "10:30", end: "12:00", type: "Aprendizado" },
                { title: "Almoçar", start: "12:00", end: "13:00", type: "Trabalho" },
                { title: "Estudar", start: "13:00", end: "16:00", type: "Pessoal" },
                { title: "Lanche da Tarde", start: "16:20", end: "16:30", type: "Trabalho" },
                { title: "Faculdade", start: "17:30", end: "22:30", type: "Pessoal" },
                { title: "Jantar", start: "22:40", end: "22:50", type: "Pessoal" },
                { title: "Dormir", start: "23:00", end: "23:30", type: "Pessoal" }
            ],
            terca: [
                { title: "Acordar", start: "07:00", end: "07:10", type: "Pessoal" },
                { title: "Café da Manhã", start: "07:20", end: "07:40", type: "Trabalho" },
                { title: "Estudar", start: "07:40", end: "09:00", type: "Pessoal" },
                { title: "Academia", start: "10:30", end: "12:00", type: "Aprendizado" },
                { title: "Almoçar", start: "12:00", end: "13:00", type: "Trabalho" },
                { title: "Estudar", start: "13:00", end: "16:00", type: "Pessoal" },
                { title: "Lanche da Tarde", start: "16:20", end: "16:30", type: "Trabalho" },
                { title: "Faculdade", start: "17:30", end: "22:30", type: "Pessoal" },
                { title: "Jantar", start: "22:40", end: "22:50", type: "Pessoal" },
                { title: "Dormir", start: "23:00", end: "23:30", type: "Pessoal" }
            ],
            quarta: [
                { title: "Acordar", start: "07:00", end: "07:10", type: "Pessoal" },
                { title: "Café da Manhã", start: "07:20", end: "07:40", type: "Trabalho" },
                { title: "Estudar", start: "07:40", end: "09:00", type: "Pessoal" },
                { title: "Academia", start: "10:30", end: "12:00", type: "Aprendizado" },
                { title: "Almoçar", start: "12:00", end: "13:00", type: "Trabalho" },
                { title: "Estudar", start: "13:00", end: "16:00", type: "Pessoal" },
                { title: "Lanche da Tarde", start: "16:20", end: "16:30", type: "Trabalho" },
                { title: "Faculdade", start: "17:30", end: "22:30", type: "Pessoal" },
                { title: "Jantar", start: "22:40", end: "22:50", type: "Pessoal" },
                { title: "Dormir", start: "23:00", end: "23:30", type: "Pessoal" }
            ],
            quinta: [
                { title: "Acordar", start: "07:00", end: "07:10", type: "Pessoal" },
                { title: "Café da Manhã", start: "07:20", end: "07:40", type: "Trabalho" },
                { title: "Estudar", start: "07:40", end: "09:00", type: "Pessoal" },
                { title: "Academia", start: "10:30", end: "12:00", type: "Aprendizado" },
                { title: "Almoçar", start: "12:00", end: "13:00", type: "Trabalho" },
                { title: "Estudar", start: "13:00", end: "16:00", type: "Pessoal" },
                { title: "Lanche da Tarde", start: "16:20", end: "16:30", type: "Trabalho" },
                { title: "Faculdade", start: "17:30", end: "22:30", type: "Pessoal" },
                { title: "Jantar", start: "22:40", end: "22:50", type: "Pessoal" },
                { title: "Dormir", start: "23:00", end: "23:30", type: "Pessoal" }
            ],
            sexta: [
                { title: "Acordar", start: "07:00", end: "07:10", type: "Pessoal" },
                { title: "Café da Manhã", start: "07:20", end: "07:40", type: "Trabalho" },
                { title: "Estudar", start: "07:40", end: "09:00", type: "Pessoal" },
                { title: "Academia", start: "10:30", end: "12:00", type: "Aprendizado" },
                { title: "Almoçar", start: "12:00", end: "13:00", type: "Trabalho" },
                { title: "Estudar", start: "13:00", end: "16:00", type: "Pessoal" },
                { title: "Lanche da Tarde", start: "16:20", end: "16:30", type: "Trabalho" },
                { title: "Jantar", start: "21:00", end: "21:30", type: "Pessoal" },
                { title: "Dormir", start: "23:00", end: "23:30", type: "Pessoal" }
            ],
            sabado: [
                { title: "Acordar", start: "07:00", end: "07:10", type: "Pessoal" },
                { title: "Café da Manhã", start: "07:20", end: "07:40", type: "Trabalho" },
                { title: "Estudar", start: "07:40", end: "09:00", type: "Pessoal" },
                { title: "Academia", start: "10:30", end: "12:00", type: "Aprendizado" },
                { title: "Almoçar", start: "12:00", end: "13:00", type: "Trabalho" },
                { title: "Estudar", start: "13:00", end: "16:00", type: "Pessoal" },
                { title: "Lanche da Tarde", start: "16:20", end: "16:30", type: "Trabalho" },
                { title: "Jantar", start: "21:00", end: "21:30", type: "Pessoal" },
                { title: "Dormir", start: "23:00", end: "23:30", type: "Pessoal" }
            ],
            domingo: [
                { title: "Acordar", start: "07:00", end: "07:10", type: "Pessoal" },
                { title: "Café da Manhã", start: "07:20", end: "07:40", type: "Trabalho" },
                { title: "Estudar", start: "07:40", end: "09:00", type: "Pessoal" },
                { title: "Almoçar", start: "12:00", end: "13:00", type: "Trabalho" },
                { title: "Lanche da Tarde", start: "16:20", end: "16:30", type: "Trabalho" },
                { title: "Jantar", start: "21:00", end: "21:30", type: "Pessoal" },
                { title: "Dormir", start: "23:00", end: "23:30", type: "Pessoal" }
            ]
        };

        const DAYS_OF_WEEK = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
        const DAYS_OF_WEEK_PT = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
        
        let config = {
            // Opcional: Define um offset de fuso horário em horas em relação ao UTC±0.
            // Ex: -3 para BRT, 1 para CET. O valor selecionado pelo usuário será salvo aqui.
            timezoneOffset: -3, 
            darkMode: (localStorage.getItem('darkMode') === 'true' || false)
        };
        
        // =======================================================================
        // 2. UTILS
        // =======================================================================
        
        /**
         * Retorna a hora atual ajustada para o fuso horário configurado.
         * @returns {Date} Objeto Date ajustado.
         */
        function getAdjustedTime() {
            const now = new Date();
            // Calcula o offset do fuso horário local em minutos e o offset configurado em minutos
            const localOffset = now.getTimezoneOffset() * 60000;
            const targetOffset = config.timezoneOffset * 3600000;
            
            // Aplica o offset do UTC para obter o tempo UTC, depois aplica o offset configurado
            const utc = now.getTime() + localOffset;
            const adjustedDate = new Date(utc + targetOffset);
            
            return adjustedDate;
        }

        /**
         * Formata um objeto Date para HH:MM.
         * @param {Date} date - O objeto Date.
         * @returns {string} Hora formatada (HH:MM).
         */
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        /**
         * Converte uma string de hora "HH:MM" para minutos desde a meia-noite.
         * @param {string} timeStr - Hora no formato "HH:MM".
         * @returns {number} Minutos.
         */
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        /**
         * Verifica se dois eventos se sobrepõem no tempo.
         * @param {object} event1 - Evento 1.
         * @param {object} event2 - Evento 2.
         * @returns {boolean} True se houver sobreposição.
         */
        function isOverlapping(event1, event2) {
            const start1 = timeToMinutes(event1.start);
            const end1 = timeToMinutes(event1.end);
            const start2 = timeToMinutes(event2.start);
            const end2 = timeToMinutes(event2.end);

            // [start1, end1) e [start2, end2)
            return Math.max(start1, start2) < Math.min(end1, end2);
        }

        /**
         * Retorna a lista de eventos para o dia da semana atual.
         * @param {string} dayKey - Chave do dia (ex: 'segunda').
         * @returns {Array<object>} Lista de eventos.
         */
        function getScheduleForDay(dayKey) {
            return SCHEDULE_DATA[dayKey] || [];
        }
        
        /**
         * Determina se um evento está ocorrendo, ainda não começou, ou já terminou.
         * @param {object} event - O objeto do evento.
         * @param {string} currentTimeStr - Hora atual no formato "HH:MM".
         * @returns {'current'|'future'|'past'} Status.
         */
        function getEventStatus(event, currentTimeStr) {
            const currentTimeMins = timeToMinutes(currentTimeStr);
            const startMins = timeToMinutes(event.start);
            const endMins = timeToMinutes(event.end);

            // Se o evento terminar no dia seguinte (como 'Dormir' até 07:00), ajustamos endMins
            let adjustedEndMins = endMins;
            if (endMins <= startMins) {
                // Se a hora de fim for menor ou igual à hora de início, assumimos que termina no dia seguinte
                adjustedEndMins = endMins + 24 * 60;
            }
            
            // Ajustamos currentTimeMins para a comparação, mas apenas se o evento começar de 00:00 a 07:00
            let adjustedCurrentTimeMins = currentTimeMins;
            if (startMins >= 23 * 60 && adjustedCurrentTimeMins < 7 * 60) {
                 // Se o evento começou ontem à noite e ainda está de manhã cedo, o tempo atual deve ser considerado "no próximo dia"
                adjustedCurrentTimeMins = currentTimeMins + 24 * 60;
            }

            if (adjustedCurrentTimeMins >= startMins && adjustedCurrentTimeMins < adjustedEndMins) {
                return 'current';
            } else if (adjustedCurrentTimeMins < startMins) {
                return 'future';
            } else {
                return 'past';
            }
        }
        
        // =======================================================================
        // 3. FUNÇÕES DE RENDERIZAÇÃO
        // =======================================================================

        const app = {
            // Referências aos elementos DOM
            elements: {
                nowView: null,
                weeklyView: null,
                timezoneSelect: null,
                darkModeToggle: null,
                dateInfo: null
            },
            
            // Estado atual (aba ativa)
            currentTab: 'now-view',
            
            /** Inicializa a aplicação */
            init() {
                this.setupDOMReferences();
                this.loadConfig();
                this.setupEventListeners();
                this.handleTimezoneChange(config.timezoneOffset, false); // Define o offset inicial
                
                // Renderiza as visualizações iniciais
                this.renderWeeklyView(); // Renderiza o grid fixo
                this.renderNowView();    // Renderiza a visão 'Agora'
                
                // Inicia o loop de atualização do tempo/status
                setInterval(() => {
                    this.updateUI();
                }, 60000); // Atualiza a cada minuto
                
                this.updateUI(); // Executa imediatamente para evitar atraso
            },
            
            /** Mapeia elementos DOM */
            setupDOMReferences() {
                this.elements.nowView = document.getElementById('now-view');
                this.elements.weeklyView = document.getElementById('weekly-view');
                this.elements.timezoneSelect = document.getElementById('timezone-select');
                this.elements.darkModeToggle = document.getElementById('dark-mode-toggle');
                this.elements.dateInfo = document.getElementById('current-date-info');
            },
            
            /** Carrega/Aplica configurações iniciais */
            loadConfig() {
                // Aplica Dark Mode
                if (config.darkMode) {
                    document.body.classList.add('dark-mode');
                    this.elements.darkModeToggle.setAttribute('aria-checked', 'true');
                } else {
                    this.elements.darkModeToggle.setAttribute('aria-checked', 'false');
                }
                
                // Seta o valor inicial do select de fuso horário
                this.elements.timezoneSelect.value = config.timezoneOffset;
            },
            
            /** Configura os event listeners */
            setupEventListeners() {
                this.elements.darkModeToggle.addEventListener('click', () => this.toggleDarkMode());
            },

            /** Alterna entre Light e Dark Mode */
            toggleDarkMode() {
                config.darkMode = !config.darkMode;
                localStorage.setItem('darkMode', config.darkMode);
                document.body.classList.toggle('dark-mode', config.darkMode);
                this.elements.darkModeToggle.setAttribute('aria-checked', config.darkMode ? 'true' : 'false');
            },
            
            /**
             * Altera o fuso horário de simulação e atualiza a UI.
             * @param {string|number} offset - Novo offset em horas.
             * @param {boolean} reRender - Forçar re-renderização completa (padrão true).
             */
            handleTimezoneChange(offset, reRender = true) {
                config.timezoneOffset = parseInt(offset, 10);
                if (reRender) {
                    this.updateUI();
                }
            },
            
            /** Atualiza o estado da UI (tempo, status e marcadores) */
            updateUI() {
                const adjustedTime = getAdjustedTime();
                const nowTimeStr = formatTime(adjustedTime);
                const dayIndex = adjustedTime.getDay(); // 0 (Dom) - 6 (Sáb)
                const dayKey = DAYS_OF_WEEK[dayIndex];
                
                // 1. Atualiza a informação de data na header
                this.elements.dateInfo.textContent = `(${DAYS_OF_WEEK_PT[dayIndex]} ${nowTimeStr} UTC${config.timezoneOffset >= 0 ? '+' : ''}${config.timezoneOffset})`;

                // 2. Atualiza a Visão Agora (se estiver ativa)
                if (this.currentTab === 'now-view') {
                    this.renderNowView();
                }
                
                // 3. Atualiza os marcadores de tempo na Visão Semanal
                this.updateTimeMarker(nowTimeStr, dayKey);
            },

            /**
             * Alterna entre as abas 'Agora' e 'Semanal'.
             * @param {string} tabId - O ID da aba a ser ativada ('now-view' ou 'weekly-view').
             */
            activateTab(tabId) {
                this.currentTab = tabId;

                // Esconde todas as sections
                this.elements.nowView.style.display = 'none';
                this.elements.weeklyView.style.display = 'none';
                
                // Mostra a section correta
                document.getElementById(tabId).style.display = 'block';

                // Atualiza o estilo dos botões
                document.querySelectorAll('.tab-button').forEach(btn => {
                    const isActive = btn.getAttribute('data-tab') === tabId;
                    btn.classList.toggle('active', isActive);
                    btn.setAttribute('aria-selected', isActive);
                    
                    // Foca no conteúdo da aba
                    document.getElementById(tabId).setAttribute('tabindex', '-1');
                });
                
                this.updateUI(); // Garante que a visão atualizada seja mostrada
            },
            
            /** Renderiza a Visão Agora (Now View) */
            renderNowView() {
                const adjustedTime = getAdjustedTime();
                const dayIndex = adjustedTime.getDay(); // 0 (Dom) - 6 (Sáb)
                const dayKey = DAYS_OF_WEEK[dayIndex];
                const nowTimeStr = formatTime(adjustedTime);
                
                const todaySchedule = getScheduleForDay(dayKey);
                let currentEvent = null;

                // Encontra o evento atual ou o próximo
                for (const event of todaySchedule) {
                    if (getEventStatus(event, nowTimeStr) === 'current') {
                        currentEvent = event;
                        break;
                    }
                }
                
                let contentHTML = '';

                if (currentEvent) {
                    // Está em um evento
                    contentHTML = `
                        <p class="now-status">
                            Agora, às <span class="time">${nowTimeStr}</span>, você está em:
                        </p>
                        <div class="current-event-card">
                            <span class="event-type-badge type-${currentEvent.type} badge">${currentEvent.type}</span>
                            <h2 class="event-title">${currentEvent.title}</h2>
                            <p class="event-time-range" aria-label="Horário do evento">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                ${currentEvent.start} – ${currentEvent.end}
                            </p>
                            <p class="now-status">Fim às ${currentEvent.end}. Foco total!</p>
                        </div>
                    `;
                } else {
                    // Fora de qualquer evento
                    
                    // Encontra o próximo evento
                    const nextEvent = todaySchedule
                        .filter(event => timeToMinutes(event.start) > timeToMinutes(nowTimeStr))
                        .sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start))[0];

                    if (nextEvent) {
                        contentHTML = `
                            <p class="now-status">
                                Agora, às <span class="time">${nowTimeStr}</span>, você está livre.
                            </p>
                            <div class="current-event-card" style="border-left-color: var(--color-text-secondary);">
                                <span class="event-type-badge type-${nextEvent.type} badge">${nextEvent.type}</span>
                                <h2 class="event-title">Próximo Evento: ${nextEvent.title}</h2>
                                <p class="event-time-range">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                                    Inicia às ${nextEvent.start}
                                </p>
                                <p class="now-status">Aproveite o tempo livre antes do próximo compromisso!</p>
                            </div>
                        `;
                    } else {
                        contentHTML = `
                            <p class="now-status">
                                Agora, às <span class="time">${nowTimeStr}</span>, você está livre.
                            </p>
                            <div class="current-event-card" style="border-left-color: var(--color-text-secondary);">
                                <h2 class="event-title">Dia concluído!</h2>
                                <p class="now-status">Não há mais eventos agendados para hoje (${DAYS_OF_WEEK_PT[dayIndex]}).</p>
                            </div>
                        `;
                    }
                }
                
                this.elements.nowView.innerHTML = contentHTML;
            },
            
            /** Renderiza o layout da Visão Semanal (Grid) */
            renderWeeklyView() {
                const startTime = 7 * 60;  // 07:00 em minutos (Início do seu dia)
                const endTime = 24 * 60;    // 00:00 (Meia noite) em minutos
                const interval = 60;        // Intervalo de 60 minutos
                
                let gridHTML = '<div class="schedule-grid" role="grid">';
                
                // Cabeçalhos (Linha 1)
                gridHTML += '<div class="grid-header">Hora</div>'; // Canto vazio
                DAYS_OF_WEEK.slice(1).forEach((day, index) => { // Segunda a Sábado
                    gridHTML += `<div class="grid-header" role="columnheader">${DAYS_OF_WEEK_PT[index + 1]}</div>`;
                });
                gridHTML += `<div class="grid-header" role="columnheader">${DAYS_OF_WEEK_PT[0]}</div>`; // Domingo

                // Linhas de Horário
                for (let timeMins = startTime; timeMins < endTime; timeMins += interval) {
                    const hour = Math.floor(timeMins / 60) % 24; // Usa módulo 24 para garantir 00h
                    const minute = timeMins % 60;
                    const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    
                    // Coluna de Hora (Time Label)
                    gridHTML += `<div class="time-label" data-time="${timeStr}" role="rowheader">${timeStr}</div>`;

                    // Células de Conteúdo (Dias da Semana)
                    // Itera de Segunda (index 1) a Domingo (index 0)
                    for (let dayIndex of [1, 2, 3, 4, 5, 6, 0]) {
                        const dayKey = DAYS_OF_WEEK[dayIndex];
                        const daySchedule = getScheduleForDay(dayKey);
                        
                        let cellContent = '';
                        let hasConflict = false;
                        
                        // Encontra eventos que caem neste intervalo de tempo (início ou durante)
                        const eventsInSlot = daySchedule.filter(event => {
                            const eventStartMins = timeToMinutes(event.start);
                            let eventEndMins = timeToMinutes(event.end);
                            
                            // Ajusta o fim do evento se passar para o dia seguinte
                            if (eventEndMins <= eventStartMins) {
                                eventEndMins += 24 * 60;
                            }
                            
                            // O evento deve começar ou estar em andamento no início do slot
                            return eventStartMins < timeMins + interval && eventEndMins > timeMins;
                        });

                        // 1. Verifica e marca colisões (conflitos de sobreposição)
                        if (eventsInSlot.length > 1) {
                            // Verifica se há conflitos reais (sobreposição de tempo)
                            for (let i = 0; i < eventsInSlot.length; i++) {
                                for (let j = i + 1; j < eventsInSlot.length; j++) {
                                    if (isOverlapping(eventsInSlot[i], eventsInSlot[j])) {
                                        hasConflict = true;
                                        break;
                                    }
                                }
                                if (hasConflict) break;
                            }
                        }

                        // 2. Cria o HTML dos eventos que se iniciam neste slot
                        eventsInSlot.forEach(event => {
                            const eventStartMins = timeToMinutes(event.start);
                            const isStartingHere = eventStartMins >= timeMins && eventStartMins < timeMins + interval;
                            
                            // Renderiza apenas se o evento começar neste slot para evitar repetição
                            if (isStartingHere) {
                                const conflictClass = hasConflict ? 'is-conflict' : '';
                                cellContent += `
                                    <div class="grid-event type-${event.type} ${conflictClass}" title="${event.title} (${event.start} - ${event.end})">
                                        <strong>${event.start}</strong> ${event.title}
                                    </div>
                                `;
                            }
                        });
                        
                        const conflictCellClass = hasConflict ? 'has-conflict' : '';
                        gridHTML += `<div class="grid-cell ${conflictCellClass}" role="gridcell" data-day="${dayKey}" data-time-start="${timeStr}">${cellContent}</div>`;
                    }
                }

                gridHTML += '</div>';
                this.elements.weeklyView.innerHTML = gridHTML;
            },

            /**
             * Adiciona/Remove a classe de tempo atual no weekly view.
             * @param {string} currentTimeStr - Hora atual no formato "HH:MM".
             * @param {string} currentDayKey - Chave do dia atual ('segunda', etc.).
             */
            updateTimeMarker(currentTimeStr, currentDayKey) {
                // Remove todos os marcadores de tempo anteriores
                document.querySelectorAll('.time-label.current-time').forEach(el => {
                    el.classList.remove('current-time');
                });
                document.querySelectorAll('.grid-event.is-current').forEach(el => {
                    el.classList.remove('is-current');
                });

                // Adiciona marcador na linha do horário (arredondado para a hora mais próxima)
                const currentHour = parseInt(currentTimeStr.substring(0, 2), 10);
                const currentHourStr = String(currentHour).padStart(2, '0') + ':00';
                
                const timeLabel = document.querySelector(`.time-label[data-time="${currentHourStr}"]`);
                if (timeLabel) {
                    timeLabel.classList.add('current-time');
                }

                // Adiciona marcador no evento atual (se houver)
                const todaySchedule = getScheduleForDay(currentDayKey);
                
                for (const event of todaySchedule) {
                    if (getEventStatus(event, currentTimeStr) === 'current') {
                        // Encontra a célula onde o evento começa
                        const cellSelector = `.grid-cell[data-day="${currentDayKey}"] div.grid-event[title*="${event.title} (${event.start}"]`;
                        const eventElement = document.querySelector(cellSelector);
                        
                        if (eventElement) {
                            eventElement.classList.add('is-current');
                            break; // Apenas um evento pode ser o atual
                        }
                    }
                }
            }
        };

        // Torna a API do app disponível globalmente para o HTML
        window.app = app;
        
        // Inicia a aplicação quando o DOM estiver completamente carregado
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
            
            // Ativa a aba 'Agora' no carregamento
            app.activateTab('now-view');
        });
    </script>
</body>
</html>
